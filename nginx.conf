server {
    listen 80;
    listen [::]:80;
    
    # 1. AQUI ESTA EL CAMBIO: Tu IP Elástica y tu Dominio
    server_name 3.139.254.175 inbank.icu www.inbank.icu;

    # Logs (guardarán los errores en la carpeta estándar de Nginx)
    access_log /var/log/nginx/inbank_access.log;
    error_log /var/log/nginx/inbank_error.log;

    # --------------------------------------------------------
    # CONFIGURACIÓN DEL BACKEND (API Node.js)
    # --------------------------------------------------------
    location /api/ {
        proxy_pass http://localhost:4000; # Tu servidor Node corre en el puerto 4000
        proxy_http_version 1.1;
        
        # WebSocket support
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        
        # Headers importantes para que el Backend sepa la IP real del usuario
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # Timeouts (para evitar errores si la base de datos tarda)
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
        
        # Desactivar buffering para respuestas streaming
        proxy_buffering off;
        proxy_cache_bypass $http_upgrade;
    }

    # Health check endpoint (opcional, pero útil)
    location /health {
        proxy_pass http://localhost:4000/health;
        access_log off;
    }

    # --------------------------------------------------------
    # CONFIGURACIÓN DEL FRONTEND (Angular)
    # --------------------------------------------------------
    location / {
        # 2. OJO CON ESTA RUTA:
        # /home/ubuntu/inbank  <- La carpeta que tú creas en el servidor (minúscula)
        # /dist/INBANK/browser <- Lo que generó tu Angular (respetando mayúsculas de tu foto)
        root /home/ubuntu/inbank/dist/INBANK/browser;
        
        index index.html;
        
        # Esto es vital para que las rutas de Angular funcionen al recargar (F5)
        try_files $uri $uri/ /index.html;
        
        # Cache control para imágenes y estilos (para que cargue rápido)
        location ~* \.(jpg|jpeg|png|gif|ico|css|js|svg|woff|woff2|ttf|eot)$ {
            expires 1y;
            add_header Cache-Control "public, immutable";
        }
        
        # No guardar cache del index.html para que los usuarios vean cambios nuevos
        location = /index.html {
            add_header Cache-Control "no-cache, no-store, must-revalidate";
            add_header Pragma "no-cache";
            add_header Expires 0;
        }
    }

    # --------------------------------------------------------
    # SEGURIDAD Y RENDIMIENTO
    # --------------------------------------------------------
    
    # Cabeceras de seguridad básicas
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header X-XSS-Protection "1; mode=block" always;

    # Compresión Gzip (hace que la web cargue más rápido)
    gzip on;
    gzip_vary on;
    gzip_min_length 1024;
    gzip_types text/plain text/css text/xml text/javascript 
               application/x-javascript application/xml+rss 
               application/javascript application/json;
}

# --------------------------------------------------------
# CONFIGURACIÓN HTTPS (Comentada hasta que uses Certbot)
# --------------------------------------------------------
# server {
#     listen 443 ssl http2;
#     listen [::]:443 ssl http2;
#     server_name inbank.icu www.inbank.icu;
#
#     ssl_certificate /etc/letsencrypt/live/inbank.icu/fullchain.pem;
#     ssl_certificate_key /etc/letsencrypt/live/inbank.icu/privkey.pem;
#     
#     # ... (Aquí iría la misma configuración de locations que arriba)
# }